name: CineSearch CI/CD Pipeline

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]

env:
    NODE_VERSION: "20.x"

jobs:
    lint:
        name: Lint & Type Check
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Run ESLint
              run: npm run lint

            - name: Run TypeScript type check
              run: npx tsc --noEmit

    unit-tests:
        name: Unit Tests
        runs-on: ubuntu-latest
        needs: lint
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Run unit tests
              run: npm run test:unit -- --coverage

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v3
              with:
                  files: ./coverage/lcov.info
                  fail_ci_if_error: false

    build-check:
        name: Build Check
        runs-on: ubuntu-latest
        needs: lint
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Install Expo CLI
              run: npm install -g expo-cli

            - name: Prebuild Expo
              run: npx expo prebuild --platform ios --no-install
              continue-on-error: true

            - name: Check Expo config
              run: npx expo config --type public

    e2e-tests:
        name: E2E Tests (iOS)
        runs-on: macos-latest
        needs: [lint, build-check]
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Setup iOS Simulator
              uses: actions/setup-ios@v2
              with:
                  platform: iOS
                  version: "16.0"
                  device: "iPhone 14"

            - name: Build for Detox
              run: npm run detox:build:ios:release
              continue-on-error: true

            - name: Run E2E tests
              run: npm run test:e2e:ios:release
              continue-on-error: true

    security-scan:
        name: Security Scan
        runs-on: ubuntu-latest
        needs: lint
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Run npm audit
              run: npm audit --production --audit-level=high

            - name: Run Snyk security scan
              uses: snyk/actions/node@master
              continue-on-error: true
              env:
                  SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

    notify:
        name: Notify
        runs-on: ubuntu-latest
        needs: [lint, unit-tests, build-check]
        if: always()
        steps:
            - name: Send notification on failure
              if: failure()
              run: |
                  echo "Workflow failed!"
                  # Add Slack/Discord notification here

            - name: Send notification on success
              if: success()
              run: |
                  echo "Workflow succeeded!"

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true
